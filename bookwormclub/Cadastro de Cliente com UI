import javax.swing.*;
import java.awt.*;
import java.awt.event.ActionEvent;
import java.sql.*;
import java.time.LocalDate;
import java.util.regex.Pattern;

public class CadastroUsuarioUI extends JFrame {

    // Configuração do banco, 1 dia inteiro pra só ter que muda o nome (vou me matar)
    private static final String URL = "jdbc:sqlserver://NOTE_GOMES:1433;databaseName=teste_Banco1;encrypt=false";
    private static final String USER = "sa";
    private static final String PASSWORD = "32452";

    // se mexer vai dar merda em tudo
    private final JTextField nomeField = new JTextField();
    private final JTextField emailField = new JTextField();
    private final JPasswordField senhaField = new JPasswordField();
    private final JComboBox<String> sexoBox = new JComboBox<>(new String[]{"Masculino", "Feminino", "Outro"});
    private final JTextField dataNascField = new JTextField("YYYY-MM-DD");
    private final JButton cadastrarButton = new JButton("Cadastrar");
    private final JButton voltarLoginButton = new JButton("Voltar para Login");

    public CadastroUsuarioUI() {
        setTitle("Cadastro de Usuário - Biblioteca Online");
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setSize(400, 450);
        setLocationRelativeTo(null);
        setResizable(false);
        initComponents();
    }

    private void initComponents() {
        JPanel panel = new JPanel(new GridBagLayout());
        panel.setBorder(BorderFactory.createEmptyBorder(20, 20, 20, 20));
        GridBagConstraints gbc = new GridBagConstraints();
        gbc.insets = new Insets(10, 10, 10, 10);
        gbc.fill = GridBagConstraints.HORIZONTAL;
        
        gbc.gridx = 0; gbc.gridy = 0;
        panel.add(new JLabel("Nome:"), gbc);
        gbc.gridx = 1;
        panel.add(nomeField, gbc);
        
        gbc.gridx = 0; gbc.gridy++;
        panel.add(new JLabel("E-mail:"), gbc);
        gbc.gridx = 1;
        panel.add(emailField, gbc);
        
        gbc.gridx = 0; gbc.gridy++;
        panel.add(new JLabel("Senha:"), gbc);
        gbc.gridx = 1;
        panel.add(senhaField, gbc);
        
        gbc.gridx = 0; gbc.gridy++;
        panel.add(new JLabel("Sexo:"), gbc);
        gbc.gridx = 1;
        panel.add(sexoBox, gbc);

        // Data de nascimento, ainda vai ter um desgraçado ue vai colocar 1945
        gbc.gridx = 0; gbc.gridy++;
        panel.add(new JLabel("Data de Nascimento:"), gbc);
        gbc.gridx = 1;
        panel.add(dataNascField, gbc);
        
        gbc.gridy++;
        gbc.gridx = 0; gbc.gridwidth = 2;
        gbc.anchor = GridBagConstraints.CENTER;
        panel.add(cadastrarButton, gbc);

        gbc.gridy++;
        panel.add(voltarLoginButton, gbc);
        
        cadastrarButton.addActionListener(this::cadastrarUsuario);
        voltarLoginButton.addActionListener(e -> voltarParaLogin());

        add(panel);
    }

    private void cadastrarUsuario(ActionEvent event) {
        String nome = nomeField.getText().trim();
        String email = emailField.getText().trim();
        String senha = new String(senhaField.getPassword());
        String sexo = (String) sexoBox.getSelectedItem();
        String dataNascTexto = dataNascField.getText().trim();
        
        if (nome.isEmpty() || email.isEmpty() || senha.isEmpty() || sexo.isEmpty() || dataNascTexto.isEmpty()) {
            JOptionPane.showMessageDialog(this, "Todos os campos são obrigatórios!", "Erro", JOptionPane.ERROR_MESSAGE);
            return;
        }
        
        if (!validarSenha(senha)) {
            JOptionPane.showMessageDialog(this,
                    "Senha inválida!\nA senha deve ter:\n- Entre 8 e 128 caracteres\n- Uma letra maiúscula\n- Uma letra minúscula\n- Um número\n- Um caractere especial (@, #, $, %, etc)",
                    "Erro de Senha", JOptionPane.ERROR_MESSAGE);
            return;
        }

        try {
            LocalDate dataNasc = LocalDate.parse(dataNascTexto);
            inserirNoBanco(nome, email, senha, sexo, dataNasc);
        } catch (Exception e) {
            JOptionPane.showMessageDialog(this, "Data de nascimento inválida! Use o formato YYYY-MM-DD.",
                    "Erro de Data", JOptionPane.ERROR_MESSAGE);
        }
    }

    private void inserirNoBanco(String nome, String email, String senha, String sexo, LocalDate dataNasc) {
        String sqlVerifica = "SELECT COUNT(*) FROM Usuario WHERE E_mail = ?";
        String sqlInsert = "INSERT INTO Usuario (nome, E_mail, Senha, Sexo, data_Nasc, Data_cadastro, Status_conta, Credencial) " +
                "VALUES (?, ?, ?, ?, ?, GETDATE(), 'Ativo', 'Cliente')";

        try (Connection conn = DriverManager.getConnection(URL, USER, PASSWORD);
             PreparedStatement stmtVerifica = conn.prepareStatement(sqlVerifica);
             PreparedStatement stmtInsert = conn.prepareStatement(sqlInsert)) {

            // Verifica se e-mail já existe, 1 hora só pra entender essa poha
            stmtVerifica.setString(1, email);
            ResultSet rs = stmtVerifica.executeQuery();
            rs.next();

            if (rs.getInt(1) > 0) {
                JOptionPane.showMessageDialog(this, "Já existe um usuário com este e-mail!", "Aviso", JOptionPane.WARNING_MESSAGE);
                return;
            }
            
            stmtInsert.setString(1, nome);
            stmtInsert.setString(2, email);
            stmtInsert.setString(3, senha); // ⚠️ Em produção, use hash (ex: BCrypt)
            stmtInsert.setString(4, sexo);
            stmtInsert.setDate(5, Date.valueOf(dataNasc));

            stmtInsert.executeUpdate();

            JOptionPane.showMessageDialog(this, "Usuário cadastrado com sucesso!", "Sucesso", JOptionPane.INFORMATION_MESSAGE);
            limparCampos();
            
            abrirTelaLogin();

        } catch (SQLException e) {
            JOptionPane.showMessageDialog(this, "Erro ao cadastrar: " + e.getMessage(),
                    "Erro de Banco", JOptionPane.ERROR_MESSAGE);
        }
    }

    private void limparCampos() {
        nomeField.setText("");
        emailField.setText("");
        senhaField.setText("");
        sexoBox.setSelectedIndex(0);
        dataNascField.setText("YYYY-MM-DD");
    }

    //  Validação de senha, só Deus sabe como isso funcionou
    private boolean validarSenha(String senha) {
        if (senha == null || senha.length() < 8 || senha.length() > 128) return false;
        String regex = "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[@#$%^&+=!]).{8,128}$";
        return Pattern.matches(regex, senha);
    }

    private void abrirTelaLogin() {
        SwingUtilities.invokeLater(() -> {
            new LoginUi().setVisible(true);
        });
        dispose(); // Fecha a tela de cadastro (chat ajudou nessa )
    }

    private void voltarParaLogin() {
        abrirTelaLogin();
    }

    public static void main(String[] args) {
        SwingUtilities.invokeLater(() -> new CadastroUsuarioUI().setVisible(true));
    }
}
